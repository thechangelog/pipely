varnishtest "Test PURGE method handling"

setenv PURGE_TOKEN "sudo"

varnish v1 -vcl {
  vcl 4.1;

  include "disable-default-backend.vcl";
  include "purge.vcl";
} -start

# PURGE with no token
client c1 {
  txreq -method PURGE -url "/"
  rxresp
  expect resp.status == 401
  expect resp.body ~ "Invalid PURGE token"
} -run

# PURGE with invalid token
client c2 {
  txreq -method PURGE -url "/" -hdr "purge-token: invalid"
  rxresp
  expect resp.status == 401
  expect resp.body ~ "Invalid PURGE token"
} -run

# PURGE with correct token
client c3 {
  txreq -method PURGE -url "/" -hdr "purge-token: sudo"
  rxresp
  expect resp.status == 200
} -run
